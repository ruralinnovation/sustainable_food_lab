---
title: "map_ia_cover_crop_use"
output: html_document
---

```{r}

library(dplyr)
library(ggplot2)
library(cori.charts)
library(cartogram)
library(sysfonts)
library(showtext)

sysfonts::font_add_google("Lato")
font_add(
  "TT Hoves",
  regular = "TypeType - TT Hoves Regular.ttf",
  bold = "TypeType - TT Hoves Bold.ttf",
  italic = "TypeType - TT Hoves Italic.ttf",
  bolditalic = "TypeType - TT Hoves Bold Italic.ttf"
)
showtext_auto()
showtext_opts(dpi = 300)

here::i_am("R/map_ia_cover_crop_use.Rmd")

source(here::here("R/utils.R"))

```


```{r}

dta_ia <- readr::read_csv(here::here("data/2017_agcensus_ia_co.csv"))

```

```{r}

# Filter to the appropriate rows
cc_desc <- c(
  "PRACTICES, LAND USE, CROPLAND, COVER CROP PLANTED, (EXCL CRP) - ACRES",
  "AG LAND, CROPLAND, HARVESTED - ACRES",
  "HAY, ALFALFA - ACRES HARVESTED",
  "HAYLAGE, ALFALFA - ACRES HARVESTED"
)


dta <- dta_ia %>%
  filter(SHORT_DESC %in% cc_desc) %>%
  filter(is.na(DOMAINCAT_DESC)) %>%
  select(-c("CENSUS_CHAPTER", "CENSUS_TABLE", "CENSUS_ROW", "CENSUS_COLUMN",
            "COMMODITY_DESC", "SECTOR_DESC")) %>%
  distinct() %>%
  mutate(
    SHORT_DESC = case_match(
      SHORT_DESC,
      "AG LAND, CROPLAND, HARVESTED - ACRES" ~ "cropland_acres_harvested",
      "HAY, ALFALFA - ACRES HARVESTED" ~ "hay_alfalfa_acres_harvested",
      "HAYLAGE, ALFALFA - ACRES HARVESTED" ~ "haylage_alfalfa_acres_harvested",
      "PRACTICES, LAND USE, CROPLAND, COVER CROP PLANTED, (EXCL CRP) - ACRES" ~ "cover_crop_acres_planted"
    ),
    VALUE = as.numeric(gsub(",", "", VALUE))
  ) %>%
  tidyr::pivot_wider(
    names_from = "SHORT_DESC",
    values_from = "VALUE"
  ) %>%
  mutate(
    haylage_alfalfa_acres_harvested = tidyr::replace_na(haylage_alfalfa_acres_harvested, 0),
    viable_cropland = cropland_acres_harvested - hay_alfalfa_acres_harvested - haylage_alfalfa_acres_harvested,
    pct_cover_crop = cover_crop_acres_planted / viable_cropland,
    geoid_co = paste0(STATE_FIPS_CODE, COUNTY_CODE)
  )

# Export data
# readr::write_csv(dta, here::here("data/ia_cover_crop_calculations.csv"))

```

```{r}

# get Iowa geometries
ia_counties <- tigris::counties(state = "IA", cb = TRUE, year = 2021)
  
dta_sf <- left_join(
    dta,
    ia_counties,
    by = c("geoid_co" = "GEOID")
  ) %>%
  sf::st_as_sf()

```

```{r}

fig <- get_ia_choropleth(dta_sf, "pct_cover_crop") +
  labs(
    title = "Percent cover crops",
    subtitle = "Share of total harvested cropland, excluding harvested alfalfa acreage",
    x = NULL,
    y = NULL,
    caption = "Source: 2017 Census of Agriculture"
  )

file_path <- paste0("export/ia_cover_crops.png")
save_plot(fig, here::here(file_path), chart_height = 7.5)

```


```{r}

fig <- get_ia_bubble_map(dta_sf, "pct_cover_crop", "cover_crop_acres_planted") +
  labs(
    title = "Percent cover crops",
    subtitle = "Share of total harvested cropland, excluding harvested alfalfa acreage. Circles sized by total acreage.",
    x = NULL,
    y = NULL,
    caption = "Source: 2017 Census of Agriculture"
  )

file_path <- paste0("export/ia_bubble_cover_crop.png")
save_plot(fig, here::here(file_path), chart_height = 8)

```

