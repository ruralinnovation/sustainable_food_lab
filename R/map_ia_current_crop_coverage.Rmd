---
title: "map_ia_current_crop_coverage"
output: html_document
---

```{r}

library(dplyr)
library(ggplot2)
library(cori.charts)
library(cartogram)
library(sysfonts)
library(showtext)

sysfonts::font_add_google("Lato")
font_add(
  "TT Hoves",
  regular = "TypeType - TT Hoves Regular.ttf",
  bold = "TypeType - TT Hoves Bold.ttf",
  italic = "TypeType - TT Hoves Italic.ttf",
  bolditalic = "TypeType - TT Hoves Bold Italic.ttf"
)
showtext_auto()
showtext_opts(dpi = 300)

here::i_am("R/map_ia_current_crop_coverage.Rmd")

```

```{r}

dta_ia <- readr::read_csv(here::here("data/2017_agcensus_ia_co.csv"))

```

```{r}

crop_desc <- c(
  # Harvest cropland variables
  "AG LAND, CROPLAND, HARVESTED - ACRES",
  "HAY, ALFALFA - ACRES HARVESTED",
  "HAYLAGE, ALFALFA - ACRES HARVESTED",
  # corn, soy, and small grains (oats, rye, wheat)
  "CORN, GRAIN - ACRES HARVESTED",
  "SOYBEANS - ACRES HARVESTED",
  "OATS - ACRES HARVESTED",
  "RYE - ACRES HARVESTED",
  "WHEAT - ACRES HARVESTED"
)

dta <- dta_ia %>%
  filter(SHORT_DESC %in% crop_desc) %>%
  filter(is.na(DOMAINCAT_DESC)) %>%
  select(-c("CENSUS_CHAPTER", "CENSUS_TABLE", "CENSUS_ROW", "CENSUS_COLUMN",
            "COMMODITY_DESC", "SECTOR_DESC")) %>%
  distinct() %>%
  mutate(
    SHORT_DESC = case_match(
      SHORT_DESC,
      "AG LAND, CROPLAND, HARVESTED - ACRES" ~ "cropland_acres_harvested",
      "HAY, ALFALFA - ACRES HARVESTED" ~ "hay_alfalfa_acres_harvested",
      "HAYLAGE, ALFALFA - ACRES HARVESTED" ~ "haylage_alfalfa_acres_harvested",
      "CORN, GRAIN - ACRES HARVESTED" ~ "corn_grain_acres_harvested",
      "SOYBEANS - ACRES HARVESTED" ~ "soybeans_acres_harvested",
      "OATS - ACRES HARVESTED" ~ "oats_acres_harvested",
      "RYE - ACRES HARVESTED" ~ "rye_acres_harvested",
      "WHEAT - ACRES HARVESTED" ~ "wheat_acres_harvested"
    ),
    VALUE = ifelse(
      is.na(as.numeric(gsub(",", "", VALUE))), 
      0,
      as.numeric(gsub(",", "", VALUE))
    )
  ) %>%
  filter(!is.na(VALUE)) %>%
  tidyr::pivot_wider(
    names_from = "SHORT_DESC",
    values_from = "VALUE"
  ) %>%
  tidyr::replace_na(
    list(
      cropland_acres_harvested = 0,
      hay_alfalfa_acres_harvested = 0,
      haylage_alfalfa_acres_harvested = 0,
      corn_grain_acres_harvested = 0,
      soybeans_acres_harvested = 0,
      oats_acres_harvested = 0,
      rye_acres_harvested = 0,
      wheat_acres_harvested = 0
    )
  ) %>%
  mutate(
    haylage_alfalfa_acres_harvested = tidyr::replace_na(haylage_alfalfa_acres_harvested, 0),
    viable_cropland = cropland_acres_harvested - hay_alfalfa_acres_harvested - haylage_alfalfa_acres_harvested,
    pct_corn_grain = corn_grain_acres_harvested / viable_cropland,
    pct_soybeans_acres = soybeans_acres_harvested / viable_cropland,
    pct_oats_acres = oats_acres_harvested / viable_cropland,
    pct_rye_acres = rye_acres_harvested / viable_cropland,
    pct_wheat_acres = wheat_acres_harvested / viable_cropland
  )

```




